function varargout = contourfnu(x,y,data,v,cmap,pos_colorbar,overticklabel,method,ninterp,nancolor)
% non-uniform contourf/imagesc/colorbar
%
%    Input variables
% x             : x-coordinates of grid, vector or 2d matrix
% y             : y-coordinates of grid, vector or 2d matrix
%                 If x and y are vectors, then length(x)==size(z,2) and length(y)==size(Z,1). 
%                 If x and y are 2d matrix, they are generated by meshgrid
% data          : 2d matrix to be ploted
%
%     Optional:
% v             : vector of contour levels (default:linspace(datamin,datamax,10))
% cmap          : color map array (default:jet)
% pos_colorbar  : 'none', or location with respect to the axes (default:'eastoutside')
% overticklabel : whether or not label the overrange ticks at colorbar (default:true)
% method        : imagesc or contourf or contour (default:imagesc)
% ninterp       : repeatedly interp times in each dimension (default:0)
% nancolor      : axis backgroud color
%
%     Output variable
% hout          : structure with handles
%                 .h     plot handle
%                 .c     contour matrix (method='contourf')
%                 .hc    colorbar handle (pos_colorbar~='none')

% % demo
% n = 50;
% x = 1:n;
% y = 1:n;
% data = peaks(n).^4;
% contour_levels = [0.5, 10, 100, 500, 1000 ];
% contour_levels2 = [0,contour_levels,5000];
% 
% % x=1:0.5:5;
% % y=1:0.5:10;
% % [x,y] = meshgrid(x,y);
% % data = x.^2+exp(y);
% % data(end-5:end,end-3:end) = nan;
% % data(end-2:end,end-2:end) = inf;
% % contour_levels = [5,20,100,1000,10000];
% % contour_levels2 = [0,contour_levels,50000];
% 
% figure('position',[1,100,1200,600])
% subplot(231)
% contourfnu(x,y,data,contour_levels)
% subplot(232)
% cmap = jet;
% cmap(1,:) = [1,1,1]; %white
% contourfnu(x,y,data,contour_levels,cmap,[],false)
% subplot(233)
% contourfnu(x,y,data,contour_levels2,cool)
% subplot(234)
% contourfnu(x,y,data,contour_levels,[],[],[],[],2)
% subplot(235)
% contourfnu(x,y,data,contour_levels,cmap,[],[],'contourf')
% subplot(236)
% contourfnu(x,y,data,contour_levels2,cool,[],[],'contourf',2)


datamax = max(data(:));
datamin = min(data(:));
datamax0 = max(data(~isinf(data(:))));
datamin0 = min(data(~isinf(data(:))));

if(~exist('v','var')||isempty(v))                    
    v = linspace(datamin0,datamax0,10); 
    v = v(2:end-1);
end
if(~exist('cmap','var')||isempty(cmap)),                   cmap = jet;                         end
if(~exist('pos_colorbar','var')||isempty(pos_colorbar)),   pos_colorbar = 'eastoutside';       end
if(~exist('overticklabel','var')||isempty(overticklabel)), overticklabel = true;               end
if(~exist('method','var')||isempty(method)),               method = 'imagesc';                 end
if(~exist('ninterp','var')||isempty(ninterp)),             ninterp = 0;                        end
if(ninterp>0)
    data=interp2(data,ninterp);
    if( strcmp(method,'contourf')||strcmp(method,'contour') )
        if( isvector(x)&&isvector(y) )  % vector to meshgrid
            [x,y] = meshgrid(x,y);
        end
        x = interp2(x,ninterp);
        y = interp2(y,ninterp);
    end
end
if( strcmp(method,'imagesc')&&~isvector(x) ) % meshgrid to vector
    x = x(1,:);
    y = y(:,1);
end

v = sort(v);
nlev = length(v);
extendmin = datamin<v(1);
extendmax = datamax>v(end);

% piecewise linear mapping,  v -> 1:nlev,    data -> 0 to nlev+1
z = zeros(size(data));
if(extendmin)
    indexinf = data==-inf;
    z(indexinf) = 0;
    index = data<v(1)&~indexinf;
    z(index) = (data(index)-datamin0)/(v(1)-datamin0);
end
for i=1:nlev-1
    index = data>=v(i) & data<v(i+1);
    z(index) = i+(data(index)-v(i))/(v(i+1)-v(i));
end
if(extendmax)
    indexinf = data==inf;
    z(indexinf) = nlev+1;
    index = data>=v(end)&~indexinf;
    z(index) = nlev+(data(index)-v(end))/(datamax0-v(end));
end
z(isnan(data)) = nan;

% draw
if(strcmp(method,'imagesc'))
%     hout.h = imagesc(x,y,z);axis xy
    hout.h = imagesc(x,y,z,'AlphaData',~isnan(z));axis xy
elseif(strcmp(method,'contourf'))
    [hout.c,hout.h] = contourf(x,y,z,0:nlev);
elseif(strcmp(method,'contour'))
    [hout.c,hout.h] = contour(x,y,z,0:nlev);
end
if(exist('nancolor','var')), set(gca,'color',nancolor); end
    
% set colormap and colorbar
Ncmap=size(cmap,1);
Ndraw=nlev-1;
if(extendmin), Ndraw = Ndraw+1; end
if(extendmax), Ndraw = Ndraw+1; end
cmapdraw(1:Ndraw,:)=cmap( round(linspace(1,Ncmap,Ndraw)) ,:);
colormap(gca,cmapdraw)
caxis([1-extendmin,nlev+extendmax])
if(~strcmp(pos_colorbar,'none'))
    hc = colorbar('location',pos_colorbar);
    ylimits = get(hc,'Ylim');
    ystep = (ylimits(2)-ylimits(1))/Ndraw;
    set(hc,'ytick',ylimits(1):ystep:ylimits(2))
    if(overticklabel)
        vlabel = v;
        if(extendmin), vlabel = [datamin vlabel]; end
        if(extendmax), vlabel = [vlabel datamax]; end
    else
        vlabel = cellstr(num2str(v'));
        if(extendmin), vlabel = [{''};vlabel]; end
        if(extendmax), vlabel = [vlabel;{''}]; end
    end
    set(hc,'yticklabel',vlabel)
    hout.hc = hc;
end

if nargout > 0
    varargout{1} = hout;
end
