function OPT = nc_cf_stationtimeseries2kmloverview(metadatadatabase,varargin)
%NC_CF_STATIONTIMESERIES2KMLOVERVIEW   kml file with links to timeseries folder on OPeNDAP server
%
%     timeseries2kmloverview(metadatadatabase,<keyword,value>)
%
%  where metadatadatabase is the excel file generated by
%  NC_CF_STATIONTIMESERIES2META.
%  where you can use the following to see the <keyword,value> pairs:
%
%     OPT = timeseries2kmloverview()
%
%See also: vaklodingen_overview, jarkus_grids_overview

% 2009-10-07: Routine changed to allow for numeric station IDs and station names [Yann Friocourt]
% TO DO: allow for multiple parameters in one kml file instead of one per kml
% TO DO: allow for more types of metadatadatabase:
%        mysql, netcdf file in opendap itself, csv file, opendap catalog.xml

%% set options

   OPT.fileName           = [];
   OPT.description        = '';
   OPT.kmlName            = 'tst.kml';
   OPT.THREDDSbase        = 'http://opendap.deltares.nl:8080/thredds/catalog/opendap/';
   OPT.HYRAXbase          = 'http://opendap.deltares.nl:8080/opendap/';
   OPT.ftpbase            = [];
   
   OPT.lineWidth          = 1;
   OPT.lineColor          = [0 0 0];
   OPT.lineAlpha          = 1;
   OPT.openInGE           = false;
   OPT.reversePoly        = false;
   OPT.text               = '';
   OPT.name               = [];
   
   OPT.lon                = [];
   OPT.lat                = [];
   OPT.z                  = [];

   OPT.iconnormalState    = 'http://maps.google.com/mapfiles/kml/shapes/placemark_square.png';
   OPT.iconhighlightState = 'http://maps.google.com/mapfiles/kml/shapes/placemark_square.png';
   
   if nargin==0
      return
   end
   
   OPT = setproperty(OPT,varargin{:});

%% get meta data

   if strcmpi(fileext(metadatadatabase),'.xls')
     [D,units] = xls2struct(metadatadatabase);
     if isnumeric(D.station_id)
         D.station_id = cellstr(num2str(D.station_id));
     else
       for i = 1:length(D.station_id)
           if isnumeric(D.station_id{i})
               D.station_id{i} = num2str(D.station_id{i});
           end
       end
       for i = 1:length(D.station_name)
           if isnumeric(D.station_name{i})
               D.station_name{i} = num2str(D.station_name{i});
           end
       end
     end
   else
      error('database type not implemented, only xls for now')
      % * opendap_folder_contents etc
      % * matroos type mysql database
      % * catalog.nc on opendap server ?
   end

%% start KML

   OPT.fid=fopen(OPT.fileName,'w');

%% HEADER

   if isempty(OPT.lon);OPT.lon = mean(D.longitude);end
   if isempty(OPT.lat);OPT.lat = mean(D.latitude); end
   if isempty(OPT.z  );OPT.z   = 100e4;            end

   OPT_header = struct(...
         'name',OPT.kmlName,...
  'description',OPT.description,...
         'open',0,...
          'lon',OPT.lon,...
          'lat',OPT.lat,...
            'z',OPT.z,...
       'timeIn',min(udunits2datenum(D.datenummin,units.datenummin)),...
      'timeOut',max(udunits2datenum(D.datenummax,units.datenummax)));
   output = KML_header(OPT_header);
   
%% LOGO

% add url of logo kml @ OpenEarth wiki

%% STYLE

   OPT_style = struct(...
       'name'     ,['style' num2str(1)],...
       'lineColor',OPT.lineColor(1,:) ,...
       'lineAlpha',OPT.lineAlpha(1),...
       'lineWidth',OPT.lineWidth(1));
   output = [output KML_style(OPT_style)];

%% marker BallonStyle

   output = [output ...
    '<Style id="normalState">'...
    '  <IconStyle><scale>0.7</scale><Icon><href>'...
    '  ' OPT.iconnormalState ''...
    '  </href></Icon></IconStyle>'...
    '  <LabelStyle><scale>0</scale></LabelStyle>'...
    '  </Style>'...
    '<Style id="highlightState">'...
    '  <IconStyle><Icon><href>'...
    '  ' OPT.iconhighlightState ''...
    '  </href></Icon></IconStyle>'...
    '  <BalloonStyle>'...
    '  <text><![CDATA[<h3>$[name]</h3>'...
    '  $[description]<hr /><br />Provided by:'...
    '  <img src="https://public.deltares.nl/download/attachments/16876019/OET?version=1" align="right" width="100"/>]]></text>'...
    '  </BalloonStyle></Style>'...
    '<StyleMap id="MarkerBalloonStyle">'...
    '  <Pair><key>normal</key><styleUrl>#normalState</styleUrl></Pair> '...
    '  <Pair><key>highlight</key><styleUrl>#highlightState</styleUrl></Pair> '...
    '  </StyleMap>'];

%% labels

   output = [output, '<Folder>'];
   output = [output, '<Name>Outlines</Name>'];

%% generate markers

   %tableContents

   for ii=1:length(D.latitude)
    %disp(sprintf('writing coordinates: % 2d / %d',ii,length(D.latitude)));

    % generate table with data info
    tableContents = [];
    
    if ~isempty(OPT.name)
    
       tableContents = [tableContents sprintf([...
        '<tr><td>station name:</td><td>%s</td></tr>'...
        '<tr><td>station code:</td><td>%s</td></tr>'...
        '<tr><td>longitude:   </td><td>%g</td></tr>'...
        '<tr><td>latitude:    </td><td>%g</td></tr>'...
        '<tr><td># times:     </td><td>%g</td></tr>'...
        '<tr><td>1st time:    </td><td>%s</td></tr>'...
        '<tr><td>last time:   </td><td>%s</td></tr>',...
        '<tr><td>min:         </td><td>%s</td></tr>'...
        '<tr><td>mean:        </td><td>%s</td></tr>',...
        '<tr><td>max:         </td><td>%s</td></tr>'...
        '<tr><td>std:         </td><td>%s</td></tr>',...
        '<tr><td>meta-info:   </td><td><a href="%s">THREDDS server</a></td></tr>'...%link to timeseries
        '<tr><td>meta-info:   </td><td><a href="%s">HYRAX   server</a></td></tr>'...%link to timeseries
        '<tr><td>data:        </td><td><a href="%s">ftp server    </a></td></tr>'...%link to timeseries
        ],...
        strtrim(D.station_name{ii}),...
        upper(strtrim(D.station_id{ii})),...
        D.longitude(ii),...
        D.latitude(ii),...
        D.number_of_observations(ii),...
        datestr(udunits2datenum(D.datenummin(ii),units.datenummin),31),...
        datestr(udunits2datenum(D.datenummax(ii),units.datenummax),31),...
       [num2str(D.([OPT.name,'_min' ])(ii),'%g'),' ',units.([OPT.name,'_min' ])],...
       [num2str(D.([OPT.name,'_mean'])(ii),'%g'),' ',units.([OPT.name,'_mean'])],...
       [num2str(D.([OPT.name,'_max' ])(ii),'%g'),' ',units.([OPT.name,'_max' ])],...
       [num2str(D.([OPT.name,'_std' ])(ii),'%g'),' ',units.([OPT.name,'_std' ])],...
       [OPT.THREDDSbase,'/',strtrim(D.filename{ii}),'.html'],...
       [OPT.HYRAXbase  ,'/',strtrim(D.filename{ii}),'.html'],...
       [OPT.ftpbase    ,'/',strtrim(D.filename{ii})])];
       
    else
    
       tableContents = [tableContents sprintf([...
        '<tr><td>station name:</td><td>%s</td></tr>'...
        '<tr><td>station code:</td><td>%s</td></tr>'...
        '<tr><td>longitude:   </td><td>%g</td></tr>'...
        '<tr><td>latitude:    </td><td>%g</td></tr>'...
        '<tr><td># times:     </td><td>%g</td></tr>'...
        '<tr><td>1st time:    </td><td>%s</td></tr>'...
        '<tr><td>last time:   </td><td>%s</td></tr>',...
        '<tr><td>meta-info:   </td><td><a href="%s">THREDDS server</a></td></tr>'...%link to timeseries
        '<tr><td>meta-info:   </td><td><a href="%s">HYRAX   server</a></td></tr>'...%link to timeseries
        '<tr><td>data:        </td><td><a href="%s">ftp server    </a></td></tr>'...%link to timeseries
        ],...
        strtrim(D.station_name{ii}),...
        upper(strtrim(D.station_id{ii})),...
        D.longitude(ii),...
        D.latitude(ii),...
        D.number_of_observations(ii),...
        datestr(udunits2datenum(D.datenummin(ii),units.datenummin),31),...
        datestr(udunits2datenum(D.datenummax(ii),units.datenummax),31),...
       [OPT.THREDDSbase,'/',strtrim(D.filename{ii}),'.html'],...
       [OPT.HYRAXbase  ,'/',strtrim(D.filename{ii}),'.html'],...
       [OPT.ftpbase    ,'/',strtrim(D.filename{ii})])];
       
    end
    
    table = [...
        '<h3>Meta information</h3>'...
        '<table border="0" padding="0" width="200">'...
        tableContents...
        '</table>'];
        
   %% preproces timespan
   %  http://code.google.com/apis/kml/documentation/kmlreference.html#timespan
   
      if  ~isnan(D.datenummin(ii))
          OPT.timeSpan = sprintf([...
              '<TimeSpan>'...
              '<begin>%s</begin>'... % OPT.timeIn
              '<end>%s</end>'...     % OPT.timeOut
              '</TimeSpan>'],...
              datestr(udunits2datenum(D.datenummin(ii),units.datenummin),'yyyy-mm-ddTHH:MM:SS'),...
              datestr(udunits2datenum(D.datenummax(ii),units.datenummax),'yyyy-mm-ddTHH:MM:SS'));
      else
          OPT.timeSpan ='';
      end

    % generate description
    output = [output, sprintf([...
        '<Placemark>'...
        '<name>%s</name>'...                                         % 1 name
        '%s' ...                                                       % 2 timeSpan
        '<snippet></snippet>'...
        '<description><![CDATA[<hr/>coordinates:  <br>'...
        '(%7.5f N,%7.5f E) <br>'...                                  % 3 lat lon
        '%s'...                                                     % 4 description
        '<hr/>'...
        '%s'...                                                        % 5 table with links
        ']]></description>'...
        '<styleUrl>#MarkerBalloonStyle</styleUrl>'...
        '<Point><coordinates>%3.8f,%3.8f,0</coordinates></Point>'... % 6 lon lat
        '</Placemark>\n'],...
         strtrim(D.station_name{ii}),... % strtrim(D.station_id{ii}),...
         OPT.timeSpan,...
         [D.latitude(ii) D.longitude(ii)],...
         [str2line(OPT.text,'s','<br>')],...
         table,...
         [D.longitude(ii) D.latitude(ii)])];
   end
   
%% FOOTER

   output = [output '</Folder>' KML_footer];
   fprintf(OPT.fid,'%c',output); % handle any % in output, cannot handle \n any more

%% close KML

   fclose(OPT.fid);
