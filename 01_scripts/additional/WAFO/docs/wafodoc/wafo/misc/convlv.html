<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>WAFO. Description of convlv</title>
  <meta name="keywords" content="convlv">
  <meta name="description" content=" Convolves real data set with a response function.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">wafo</a> &gt; <a href="index.html">misc</a> &gt; convlv.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for wafo\misc&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>convlv
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong> Convolves real data set with a response function.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong> y = convlv(x,h,dim,flag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> <a href="convlv.html" class="code" title=" Convolves real data set with a response function.  ">CONVLV</a> Convolves real data set with a response function.  
  
   CALL:  y = <a href="convlv.html" class="code" title=" Convolves real data set with a response function.  ">convlv</a>(x,h,dim,flag); 
  
   y,x  = filtered data and raw data, respectively. 
   h    = vector with filter coefficients. 
   dim  = dimension to filter. 
   flag = 'periodic'    : if X is periodic 
          'nonperiodic' : otherwise (default) 
    
  <a href="convlv.html" class="code" title=" Convolves real data set with a response function.  ">CONVLV</a> convolves X with H, i.e., : 
  
               nr 
        Y(i) = sum Cn(n)*X(i+n) 
               n=-nl 
   where 
     H(1) = Cn(0), H(2)=Cn(-1),...H(Nl+1)=Cn(-Nl), and H(Np) = Cn(1), 
     H(Np-1) = Cn(2),...H(Np-Nr) = Cn(Nr), 
  
  Note: The filter, H, must be stored in wrap-around order, i.e., the 
        first half of the array H contains the impulse response 
        function at positive times, while the second half of the array 
        contains the impulse response function at negative times, 
        counting down from the highest element.  
  
  Example: 
  dx = 2*pi/100;  
  x = linspace(0,2*pi-dx,100)'; 
  y = cos(x); 
  c = <a href="savgol.html" class="code" title="  Savitzky-Golay filter coefficients. ">savgol</a>(2,2,4,1);          % differentiation filter 
  yf = <a href="convlv.html" class="code" title=" Convolves real data set with a response function.  ">convlv</a>(y,c)/dx;          % derivative 
  yf2 = <a href="convlv.html" class="code" title=" Convolves real data set with a response function.  ">convlv</a>(y,c,[],'p')/dx;   
  semilogy(x,abs(sin(x)+yf),x,abs(sin(x)+yf2),'g') 
  
  See also  <a href="savgol.html" class="code" title="  Savitzky-Golay filter coefficients. ">savgol</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<TABLE BORDER=0>

<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\datafun\conv.m">conv</a></li></TD>
<TD>          Convolution and polynomial multiplication.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\lang\error.m">error</a></li></TD>
<TD>         Display message and abort function.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\datafun\@logical\fft.bi">fft</a></li></TD>
<TD>           Discrete Fourier transform.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\datafun\@logical\ifft.bi">ifft</a></li></TD>
<TD>          Inverse discrete Fourier transform.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\robust\robust\@umat\ipermute.m">ipermute</a></li></TD>
<TD>      Inverse permute array dimensions.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\elmat\nan.m">nan</a></li></TD>
<TD>           Not-a-Number.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\elfun\nextpow2.m">nextpow2</a></li></TD>
<TD>      Next higher power of 2.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\elmat\@char\permute.bi">permute</a></li></TD>
<TD>       Permute array dimensions.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\elmat\shiftdim.m">shiftdim</a></li></TD>
<TD>      Shift dimensions.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\strfun\@char\strncmpi.bi">strncmpi</a></li></TD>
<TD>      Compare first N characters of strings ignoring case.</TD>
</TR>
</TABLE>
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<TABLE BORDER=0>

</TABLE>

</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code"> yi = linear(x,y,xi);</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>001 <span class="keyword">function</span> y = <a name="_sub0" href="#_subfunctions" class="code">convlv</a>(x,h,dim,flag) 
002 <span class="comment">%CONVLV Convolves real data set with a response function.  </span>
003 <span class="comment">% </span>
004 <span class="comment">%  CALL:  y = convlv(x,h,dim,flag); </span>
005 <span class="comment">% </span>
006 <span class="comment">%  y,x  = filtered data and raw data, respectively. </span>
007 <span class="comment">%  h    = vector with filter coefficients. </span>
008 <span class="comment">%  dim  = dimension to filter. </span>
009 <span class="comment">%  flag = 'periodic'    : if X is periodic </span>
010 <span class="comment">%         'nonperiodic' : otherwise (default) </span>
011 <span class="comment">%   </span>
012 <span class="comment">% CONVLV convolves X with H, i.e., : </span>
013 <span class="comment">% </span>
014 <span class="comment">%              nr </span>
015 <span class="comment">%       Y(i) = sum Cn(n)*X(i+n) </span>
016 <span class="comment">%              n=-nl </span>
017 <span class="comment">%  where </span>
018 <span class="comment">%    H(1) = Cn(0), H(2)=Cn(-1),...H(Nl+1)=Cn(-Nl), and H(Np) = Cn(1), </span>
019 <span class="comment">%    H(Np-1) = Cn(2),...H(Np-Nr) = Cn(Nr), </span>
020 <span class="comment">% </span>
021 <span class="comment">% Note: The filter, H, must be stored in wrap-around order, i.e., the </span>
022 <span class="comment">%       first half of the array H contains the impulse response </span>
023 <span class="comment">%       function at positive times, while the second half of the array </span>
024 <span class="comment">%       contains the impulse response function at negative times, </span>
025 <span class="comment">%       counting down from the highest element.  </span>
026 <span class="comment">% </span>
027 <span class="comment">% Example: </span>
028 <span class="comment">% dx = 2*pi/100;  </span>
029 <span class="comment">% x = linspace(0,2*pi-dx,100)'; </span>
030 <span class="comment">% y = cos(x); </span>
031 <span class="comment">% c = savgol(2,2,4,1);          <span class="comment">% differentiation filter </span></span>
032 <span class="comment">% yf = convlv(y,c)/dx;          <span class="comment">% derivative </span></span>
033 <span class="comment">% yf2 = convlv(y,c,[],'p')/dx;   </span>
034 <span class="comment">% semilogy(x,abs(sin(x)+yf),x,abs(sin(x)+yf2),'g') </span>
035 <span class="comment">% </span>
036 <span class="comment">% See also  savgol   </span>
037  
038 <span class="comment">%History   </span>
039 <span class="comment">% Revised pab 2003 </span>
040 <span class="comment">% - fixed a bug when nr=nl=0 and when nh~=1   </span>
041 <span class="comment">% By Per A. Brodtkorb 2001 </span>
042    
043 error(nargchk(2,4,nargin)) 
044 <span class="keyword">if</span> nargin&lt;3,dim =[];<span class="keyword">end</span> 
045 <span class="keyword">if</span> nargin&lt;4|isempty(flag),flag =<span class="string">'nonperiodic'</span>;<span class="keyword">end</span> 
046  
047 perm = []; nshifts = 0; 
048 <span class="keyword">if</span> ~isempty(dim) 
049   perm = [dim:max(ndims(x),dim) 1:dim-1]; 
050   x = permute(x,perm); 
051 <span class="keyword">else</span>                       
052   [x,nshifts] = shiftdim(x); 
053 <span class="keyword">end</span> 
054 xsiz = size(x); 
055  
056 <span class="keyword">if</span> isempty(perm)  
057   h    = shiftdim(h); 
058   hsiz = size(h); 
059 <span class="keyword">else</span> 
060   hsiz = size(h) 
061   <span class="keyword">if</span> prod(hsiz)==prod(xsiz) 
062     h = permute(h,perm); 
063     hsiz = size(h) 
064   <span class="keyword">end</span> 
065 <span class="keyword">end</span> 
066  
067 m  = xsiz(1); 
068 mh = hsiz(1); 
069 nh = prod(hsiz(2:<span class="keyword">end</span>)); 
070 p  = ceil(mh/2); 
071 nhr = prod(xsiz(2:<span class="keyword">end</span>)) - nh + 1; 
072  
073 <span class="keyword">if</span> (p==mh) 
074   y  = x(:,:).*h(ones(m,1),:); 
075 <span class="keyword">else</span> 
076   nl = max(find(h(1:p,1)));      <span class="comment">% Number of non-zero elements to the left </span>
077   nr = max(find(h(mh:-1:p+1,1)));<span class="comment">% and to the right. </span>
078   nz = nr+nl;                    <span class="comment">% Total number of non-zero elements </span>
079    
080    
081   <span class="keyword">if</span> strncmpi(flag,<span class="string">'p'</span>,1) 
082     <span class="comment">% periodic endconditions </span>
083     nfft = max(m,nz); 
084     hw   = fft([h(1:p,:); zeros(nfft-mh,nh); h(p+1:<span class="keyword">end</span>,:)]); 
085     y    = real(ifft(fft(x(:,:),nfft).*repmat(hw,[1,nhr]))); <span class="comment">% convolution </span>
086     y    = reshape(y(1:m,:),[ones(1,nshifts),xsiz]); 
087   <span class="keyword">else</span> 
088     <span class="comment">% nonperiodic end conditions </span>
089     <span class="comment">% Extrapolate x linearly outside outside the range to lessen the end </span>
090     <span class="comment">% effects </span>
091     y  = <a href="#_sub1" class="code" title="sub  yi = linear(x,y,xi);">linear</a>((1:m)',x(:,:),(-nl+1:m+nr)'); 
092     <span class="comment">%  y  = spline((1:m)',x(:,:),(-nl+1:m+nr)'); </span>
093     <span class="keyword">if</span> 0, 
094       <span class="comment">%This is wrong </span>
095       y=(conv(y,-h(1:p,:))+flipud(conv(flipud(y),-[0; h(<span class="keyword">end</span>:-1:p+1,:)])));  
096     <span class="keyword">else</span> 
097       nfft = 2^nextpow2(m+nz); 
098       hw   = fft([h(1:p,:); zeros(nfft-mh,nh); h(p+1:<span class="keyword">end</span>,:)]); 
099       y  = real(ifft(fft(y(:,:),nfft).*repmat(hw,[1,nhr]))); <span class="comment">% convolution </span>
100     <span class="keyword">end</span> 
101     y = reshape(y(nl+1:nl+m,:),[ones(1,nshifts),xsiz]); 
102      
103   <span class="keyword">end</span> 
104 <span class="keyword">end</span> 
105 <span class="keyword">if</span> ~isempty(perm), y = ipermute(y,perm); <span class="keyword">end</span>   
106  
107  
108  
109 <span class="keyword">function</span> yi = <a name="_sub1" href="#_subfunctions" class="code">linear</a>(x,y,xi); 
110 <span class="comment">% LINEAR Interpolation and extrapolation </span>
111 <span class="comment">% </span>
112 <span class="comment">% CALL: yi = linear(x,y,xi); </span>
113 <span class="comment">% </span>
114 <span class="comment">%  x, xi   = column vectors </span>
115 <span class="comment">%  y, yi   = column vectors or matrices </span>
116 <span class="comment">% </span>
117  
118 siz = size(xi); 
119 n = length(x); 
120 ni = length(xi); 
121 <span class="keyword">if</span> ni~=1 
122     [xxi,k] = sort(xi); 
123     [dum,j] = sort([x;xxi]); 
124     r(j) = 1:n+ni; 
125     r    = r(n+1:<span class="keyword">end</span>)-(1:ni); 
126     r(k) = r; 
127     r    = max(1,min(r,n-1)); 
128     u    = (xi-x(r))./(x(r+1)-x(r)); 
129     yi   = y(r,:)+(y(r+1,:)-y(r,:)).*u(:,ones(1,size(y,2))); 
130 <span class="keyword">else</span> 
131     <span class="comment">% Special scalar xi case </span>
132     r = max(find(x &lt;= xi)); 
133     <span class="keyword">if</span> isempty(r),  <span class="comment">% xi&lt;x(1) </span>
134       r=1;  
135     <span class="keyword">elseif</span> r==n,    <span class="comment">% x(n)&lt;=xi </span>
136       r = n-1; 
137     <span class="keyword">end</span> 
138     <span class="keyword">if</span> (r&gt;0) &amp; (r&lt;n), 
139         u = (xi-x(r))./(x(r+1)-x(r)); 
140         yi=y(r,:)+(y(r+1,:)-y(r,:)).*u(:,ones(1,size(y,2))); 
141     <span class="keyword">else</span> 
142         yi = NaN; 
143     <span class="keyword">end</span> 
144 <span class="keyword">end</span> 
145 <span class="keyword">if</span> (min(size(yi))==1) &amp; (prod(siz)&gt;1), yi = reshape(yi,siz); <span class="keyword">end</span> 
146  
147 <span class="keyword">return</span></pre></div>
<HR noShade>
<SMALL><A href="http://www.maths.lth.se/matstat/">Mathematical 
Statistics</A><BR><A href="http://www.maths.lth.se/">Centre for Mathematical 
Sciences</A><BR><A href="http://www.lu.se/">Lund University</A> with <A 
href="http://www.lth.se/">Lund Institute of Technology</A> </SMALL>
<P><SMALL>Comments or corrections to the <A
href="mailto:wafo@maths.lth.se">WAFO group</A>  </P>

<hr><address>Generated on Thu 06-Oct-2005 02:21:16
 for <strong><A href="http://www.maths.lth.se/matstat/wafo/">WAFO</A></strong>
 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>