<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>WAFO. Description of emem</title>
  <meta name="keywords" content="emem">
  <meta name="description" content="  Extended Maximum Entropy Method">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">wafo</a> &gt; <a href="../index.html">multidim</a> &gt; <a href="index.html">private</a> &gt; emem.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for wafo\multidim\private&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>emem
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>  Extended Maximum Entropy Method</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong> DS = emem(Sxyn,Gwt,theta,fi,k,opt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> <a href="emem.html" class="code" title="  Extended Maximum Entropy Method  ">EMEM</a>  Extended Maximum Entropy Method  
  
   CALL: DS = <a href="emem.html" class="code" title="  Extended Maximum Entropy Method  ">emem</a>(Sxyn,Gwt,thetai,fi,k)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<TABLE BORDER=0>

<TR>
<TD><li><a href="mlm.html" class="code" title=" DS = mlm(Sxy,Gwt,thetai,fi,k,opt)">mlm</a></li></TD>
<TD>  maximum likelihood method for estimating the directional distribution</TD>
</TR>
<TR>
<TD><li><a href="normspfn.html" class="code" title=" DS = normspfn(DS,thetai)">normspfn</a></li></TD>
<TD> normalizes the spreading function</TD>
</TR>
<TR>
<TD><li><a href="../../../wafo/wstats/var.html" class="code" title=" y = var(x, dim)">var</a></li></TD>
<TD>  Variance</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\iofun\@serial\close.m">close</a></li></TD>
<TD>         Close figure.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\datafun\@int16\diff.bi">diff</a></li></TD>
<TD>          Difference and approximate derivative.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\graphics\drawnow.m">drawnow</a></li></TD>
<TD>       Flush pending graphics events.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="c:\pab\matlab\graphutil\hline.m">hline</a></li></TD>
<TD>         plots horizontal line(s)</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\audiovideo\@audiorecorder\pause.m">pause</a></li></TD>
<TD>         Wait for user response.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\elmat\@char\permute.bi">permute</a></li></TD>
<TD>       Permute array dimensions.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\ident\ident\@iddata\plot.m">plot</a></li></TD>
<TD>          Linear plot.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\graph2d\semilogy.bi">semilogy</a></li></TD>
<TD>      Semi-log scale plot.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\strfun\sprintf.m">sprintf</a></li></TD>
<TD>       Write formatted data to string.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\graph2d\subplot.m">subplot</a></li></TD>
<TD>       Create axes in tiled positions.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\graph2d\title.m">title</a></li></TD>
<TD>         Graph title.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\datafun\trapz.m">trapz</a></li></TD>
<TD>         Trapezoidal numerical integration.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\uitools\waitbar.m">waitbar</a></li></TD>
<TD>       Display wait bar.</TD>
</TR>
<TR>
<TD><li><a href="" class="code" title="C:\programs\matlab71\toolbox\matlab\lang\warning.m">warning</a></li></TD>
<TD>       Display warning message; disable or enable warning messages.</TD>
</TR>
</TABLE>
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<TABLE BORDER=0>

<TR>
<TD><li><a href="../../../wafo/multidim/dat2dspec.html" class="code" title=" [Sd,D,Sw,Fcof,Gwt,Sxy,Sxy1] = dat2dspec2(xn,pos,h,nfft,nt,method,varargin)">dat2dspec</a></li></TD>
<TD> Estimates the directional wave spectrum from timeseries</TD>
</TR>
</TABLE>

</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>001 <span class="keyword">function</span> DS = <a name="_sub0" href="#_subfunctions" class="code">emem</a>(Sxyn,Gwt,theta,fi,k,opt) 
002 <span class="comment">%EMEM  Extended Maximum Entropy Method  </span>
003 <span class="comment">% </span>
004 <span class="comment">%  CALL: DS = emem(Sxyn,Gwt,thetai,fi,k) </span>
005 <span class="comment">% </span>
006  
007 <span class="comment">%Tested on matlab 6.0   </span>
008 <span class="comment">%History :  </span>
009 <span class="comment">%By pab Oct-Nov 2002 </span>
010    
011 <span class="comment">%Reference: </span>
012 <span class="comment">% Hashimoto,N. (1997)  </span>
013 <span class="comment">% &quot;Analysis of the directional wave spectra from field data.&quot;, Advances in  </span>
014 <span class="comment">% Coastal and Ocean Engineering, Vol.3., pp.103-143 </span>
015  
016 [m, nt, nf] = size(Gwt); 
017  
018  
019 H   = zeros(m*m,nt,nf); 
020 phi = zeros(m*m,nf); 
021  
022 <span class="comment">% Eliminate meaningless equations such as those determined  </span>
023 <span class="comment">% from the zero co-spectrum and zero quadrature-spectrum. </span>
024 M = 0;  <span class="comment">% M is the number of independent equations </span>
025  
026 dtheta = theta(2)-theta(1); 
027 tol    = sqrt(eps); <span class="comment">% treshold defining zero for transfer functions </span>
028 <span class="keyword">for</span> ix=1:m 
029   <span class="keyword">for</span> iy=ix:m 
030     Htemp  = Gwt(ix,:,:).*conj(Gwt(iy,:,:));                         
031     <span class="keyword">if</span> (any(any(abs(diff(real(Htemp),1))&gt;tol*dtheta))) 
032       M        = M+1; 
033       phi(M,:) = real(Sxyn(ix,iy,:)); 
034       H(M,:,:) = real(Htemp);  
035     <span class="keyword">end</span> 
036     <span class="keyword">if</span> any(any(abs(diff(imag(Htemp),1))&gt;tol*dtheta) ) 
037       M            = M+1; 
038       phi(M,:) = imag(Sxyn(ix,iy,:)); 
039       H(M,:,:) = imag(Htemp);           
040     <span class="keyword">end</span> 
041   <span class="keyword">end</span> 
042 <span class="keyword">end</span> 
043  
044 <span class="comment">% Note: H and Phi here are normalized in another way than described in Hashimoto,N. (1997). </span>
045 H   = H(1:M,:,:); 
046 phi = phi(1:M,:); 
047  
048 warningState = warning; 
049 warning off; 
050  
051 M2 = floor(M/2+1); 
052  
053 <span class="comment">% Constants controlling the calculation </span>
054 coefAbsTol    = 0.01; 
055 coefAbsTol2   = 500; 
056 errorTol      = 0.0005;<span class="comment">%sqrt(eps); </span>
057 maxIter       = 25; 
058 minModelOrder = 1; 
059 maxModelOrder = M2; 
060 Li            = 1 ; <span class="comment">%relaxation parameter </span>
061 AICTol        = 0.1; 
062 maxCoef       = 10000; 
063  
064 display =0; 
065 <span class="keyword">if</span> nargin&gt;5 
066   <span class="keyword">if</span> ~isempty(opt.errortol), errorTol = opt.errortol; <span class="keyword">end</span> 
067   <span class="keyword">if</span> ~isempty(opt.maxiter),  maxIter  = opt.maxiter; <span class="keyword">end</span> 
068   <span class="keyword">if</span> ~isempty(opt.relax),    Li       = opt.relax; <span class="keyword">end</span> 
069   <span class="keyword">if</span> ~isempty(opt.maxcoef),  maxCoef  = opt.maxcoef; <span class="keyword">end</span> 
070   <span class="keyword">if</span> ~isempty(opt.message),  display  = opt.message; <span class="keyword">end</span> 
071   <span class="keyword">if</span> ~isempty(opt.coefabstol),       coefAbsTol = opt.coefabstol; <span class="keyword">end</span> 
072   <span class="keyword">if</span> ~isempty(opt.minmodelorder), minModelOrder = opt.minmodelorder; <span class="keyword">end</span> 
073   <span class="keyword">if</span> ~isempty(opt.maxmodelorder), maxModelOrder = opt.maxmodelorder; <span class="keyword">end</span> 
074 <span class="keyword">end</span> 
075  
076  
077  
078 cosn  = cos([1:maxModelOrder]'*theta'); 
079 sinn  = sin([1:maxModelOrder]'*theta'); 
080 cosnt = permute(repmat(cosn,[1 1 M]),[2 3 1]); 
081 sinnt = permute(repmat(sinn,[1 1 M]),[2 3 1]); 
082  
083 AIC       = zeros(1,maxModelOrder); 
084 XY        = zeros(2*maxModelOrder,M); 
085 coef      = zeros(1,2*maxModelOrder); <span class="comment">% [a,b] </span>
086 deltaCoef = zeros(1,2*maxModelOrder); <span class="comment">% [deltaA,deltaB] </span>
087  
088 Nbest = 0; <span class="comment">%Best model order </span>
089  
090 DS = repmat(1/(2*pi),nt,nf); <span class="comment">% initialize DS </span>
091       
092 h = waitbar(0,<span class="string">'Please wait...EMEM calculation'</span>); 
093  
094 <span class="comment">% compute a fast estimate in order to find a good </span>
095 <span class="comment">% starting guess for the Lagrange multipliers  </span>
096 DS0   = log(<a href="mlm.html" class="code" title="  maximum likelihood method for estimating the directional distribution ">mlm</a>(Sxyn,Gwt,theta,fi,k)); 
097 Oneth = ones(nt,1); 
098  
099 <span class="keyword">for</span> ff=k, <span class="comment">% loop over frequencies where S(f)&gt;0 </span>
100   waitbar(ff/k(<span class="keyword">end</span>),h) 
101      
102   Hj     = H(:,:,ff).';  <span class="comment">%H(1:M,1:nt)  </span>
103   Phij = repmat(phi(1:M,ff).',nt,1);  
104      
105   stop = 0; 
106    
107   <span class="comment">% Assume model order change smoothly over the frequencies </span>
108   localMinModelOrder = max(minModelOrder,ceil(Nbest/2)); 
109    
110   N    = localMinModelOrder-1; 
111       
112   <span class="keyword">while</span>(~stop), <span class="comment">% loop until the right model order is found </span>
113     N         = N+1; <span class="comment">%increment modelOrder </span>
114      
115     <span class="comment">% coef0=starting guess for coefs multipliers  </span>
116     coef0 = zeros(1,2*N+1); 
117     <span class="comment">%coef0 = [Oneth, cosn(1:N,:).', sinn(1:N,:).'] \ DS0(:,ff);  </span>
118     coef(1:2*N) = coef0(2:2*N+1); 
119     <span class="comment">%coef(1:2*N)      = zeros(1,2*N); <span class="comment">% [a,b] </span></span>
120     deltaCoef(1:2*N) = zeros(1,2*N); <span class="comment">% [deltaA,deltaB] </span>
121      
122     <span class="comment">%coef(2*N-1:2*N)      = zeros(1,2); <span class="comment">% [a,b] </span></span>
123     <span class="comment">%deltaCoef(2*N-1:2*N) = zeros(1,2); <span class="comment">% [deltaA,deltaB] </span></span>
124      
125     count      = 0; 
126     lambda     = Li; <span class="comment">%relaxation parameter      </span>
127     modelFound = 0; 
128      
129     exponent  = (coef(1:N)*cosn(1:N,:)+coef(N+1:2*N)*sinn(1:N,:))'; 
130     a0     = -max(exponent); <span class="comment">% trick in order to avoid infinities </span>
131     Fn     = exp(a0+exponent); 
132     Dn     = repmat(Fn/(trapz(Fn)*dtheta),1,M); <span class="comment">%Fn(theta|f)/norm(Fn)=Dn(theta|f) </span>
133     PhiHD  = (Phij-Hj).*Dn; 
134     Z      = trapz(PhiHD,1)*dtheta; <span class="comment">% 1xM </span>
135     error1 = max(abs(Z)); 
136      
137     <span class="keyword">while</span> ( ~stop &amp; ~modelFound),<span class="comment">%Use Newton-Raphson iteration to find model. </span>
138        
139       count = count+1; 
140        
141       <span class="comment">%XY is the negative jacobian in the Newton iteration. </span>
142       <span class="keyword">for</span> ix=1:N 
143     <span class="comment">%This better than eq. 97 and 98 in Hashimoto (1997). </span>
144     <span class="comment">%X(ix,1:M)= </span>
145     XY(ix,:)   = (Z.*trapz(Dn.*cosnt(:,:,ix),1) - <span class="keyword">...</span> 
146               trapz(PhiHD.*cosnt(:,:,ix),1))*dtheta; 
147     <span class="comment">%Y(ix,1:M)= </span>
148     XY(N+ix,:) = (Z.*trapz(Dn.*sinnt(:,:,ix),1) - <span class="keyword">...</span> 
149               trapz(PhiHD.*sinnt(:,:,ix),1))*dtheta ; 
150       <span class="keyword">end</span> 
151        
152       deltaCoefOld     = deltaCoef(1:2*N); 
153       deltaCoef(1:2*N) = Z/XY(1:2*N,:); <span class="comment">% solve eq. 95 by least square </span>
154                      
155       coef(1:2*N) = coef(1:2*N) + lambda*deltaCoef(1:2*N); 
156        
157       <span class="keyword">if</span> (maxCoef&lt;inf) <span class="comment">%This option is not described in Hashimoto,N. (1997). </span>
158     <span class="comment">%Make sure the coefficients do not diverge to infinity </span>
159     k0 = find(abs(coef(1:2*N))&gt;maxCoef); 
160     <span class="keyword">if</span> any(k0) 
161       deltaCoef(k0)=(sign(deltaCoef(k0)).*maxCoef-<span class="keyword">...</span> 
162              (coef(k0)-lambda*deltaCoef(k0)))/lambda; 
163       coef(k0)     = sign(coef(k0)).*maxCoef; 
164     <span class="keyword">end</span> 
165       <span class="keyword">end</span> 
166        
167       exponent  = (coef(1:N)*cosn(1:N,:)+coef(N+1:2*N)*sinn(1:N,:))'; 
168       a0     = -max(exponent); <span class="comment">% trick in order to avoid infinities </span>
169       Fn     = exp(a0+exponent); 
170       Dn     = repmat(Fn/(trapz(Fn)*dtheta),1,M); <span class="comment">%Fn(theta|f)/norm(Fn)=Dn(theta|f) </span>
171       PhiHD  = (Phij-Hj).*Dn; 
172       Z      = trapz(PhiHD,1)*dtheta; <span class="comment">% 1xM </span>
173        
174       error2 = error1; 
175       error1 = max(abs(Z)); 
176        
177       <span class="keyword">if</span> (~any(abs(deltaCoef(1:2*N))&gt;coefAbsTol)  | (error1 &lt;= errorTol)); 
178      modelFound = 1; 
179       <span class="keyword">elseif</span> (count&gt;maxIter | ((error2&lt;error1) &amp; <span class="keyword">...</span> 
180     (any(abs(deltaCoef(1:2*N)-deltaCoefOld)&gt;coefAbsTol2) ))), 
181      
182     <span class="comment">% Coefficients are diverging and error is increasing </span>
183     <span class="comment">% solution: under relax the computation or quit </span>
184     <span class="keyword">if</span>(lambda&gt;Li*2^-4),  
185       lambda      = lambda*0.5; 
186       count       = 0; 
187       deltaCoef(1:2*N) = 0; 
188      <span class="comment">% coef(1:2*N)      = 0; </span>
189       coef(1:2*N) = coef0(2:2*N+1); 
190       Dn     = repmat(1/(2*pi),nt,M); <span class="comment">%Dn(theta|f) </span>
191       PhiHD  = (Phij-Hj).*Dn; 
192       Z      = trapz(PhiHD,1)*dtheta; <span class="comment">% 1xM </span>
193       error2 = inf; 
194       error1 = max(abs(Z)); 
195     <span class="keyword">else</span> 
196       stop = 1; 
197     <span class="keyword">end</span> 
198       <span class="keyword">end</span> 
199        
200       <span class="keyword">if</span> 0 <span class="comment">%modelFound </span>
201       Np = 4; 
202       subplot(Np,1,1), semilogy(abs(Z)+eps,<span class="string">'*'</span>),hline(errorTol), title(<span class="string">'error'</span>) 
203       subplot(Np,1,2),plot(deltaCoef(1:2*N),<span class="string">'g*'</span>), title(<span class="string">'deltaCoef'</span>) 
204       subplot(Np,1,3), plot(coef(1:2*N),<span class="string">'r*'</span>), title(<span class="string">'coef'</span>) 
205       subplot(Np,1,4), plot(theta,Dn) 
206       drawnow,<span class="comment">% </span>
207       disp(<span class="string">'Hit any key'</span>),pause 
208       <span class="keyword">end</span> 
209     <span class="keyword">end</span> <span class="comment">%while Newton-Raphson </span>
210              
211     AIC(N) = M*(log(2*pi*<a href="../../../wafo/wstats/var.html" class="code" title="  Variance ">var</a>(Z))+1)+4*N+2; <span class="comment">%Aikakes Information Criterion </span>
212        
213     <span class="keyword">if</span>(N&gt;localMinModelOrder), 
214       stop = stop | (AIC(N)+AICTol&gt;AIC(N-1)) ; 
215     <span class="keyword">end</span> 
216     <span class="keyword">if</span> isnan(AIC(N)), stop = 1;  <span class="keyword">end</span> <span class="comment">%this should never happen </span>
217      
218     <span class="keyword">if</span> (stop), 
219       <span class="keyword">if</span> (N&gt;localMinModelOrder) 
220     Nbest = N-1; 
221     coef(1:2*Nbest) = coefOld; 
222       <span class="keyword">else</span> 
223     Nbest = 1; 
224     coef = zeros(1,2*Nbest); 
225       <span class="keyword">end</span> 
226     <span class="keyword">else</span> 
227       Nbest   = N; 
228       stop    = (N&gt;=maxModelOrder); 
229       coefOld = coef(1:2*N); 
230     <span class="keyword">end</span> 
231        
232   <span class="keyword">end</span> <span class="comment">% while </span>
233    
234   <span class="keyword">if</span> display&gt;0 
235     disp(sprintf(<span class="string">'f = %g \t \t Model order = %d \t \t error = %g'</span>,fi(ff),Nbest,max(abs(Z)))) 
236   <span class="keyword">end</span> 
237   <span class="comment">%plot(deltaCoef,'r*'),hold on,plot(coef(1:2*Nbest),'g*'),hold off,pause </span>
238    
239   exponent  = (coef(1:Nbest)*cosn(1:Nbest,:)+coef(Nbest+1:2*Nbest)*sinn(1:Nbest,:)).'; 
240   a0     = -max(exponent); <span class="comment">% trick in order to avoid infinities </span>
241   DS(:,ff) = exp(a0+exponent); 
242          
243 <span class="keyword">end</span> <span class="comment">% for ff= </span>
244 close(h) 
245 DS = <a href="normspfn.html" class="code" title=" normalizes the spreading function ">normspfn</a>(DS,theta); 
246  
247 warning(warningState); 
248  
249 <span class="keyword">if</span> (all(abs(DS(:)-DS(1))&lt;sqrt(eps))) 
250   warning(<span class="string">'No main direction found. Check the estimated spectrum!'</span>) 
251 <span class="keyword">end</span> 
252  
253 <span class="keyword">return</span>; <span class="comment">% EMEM</span></pre></div>
<HR noShade>
<SMALL><A href="http://www.maths.lth.se/matstat/">Mathematical 
Statistics</A><BR><A href="http://www.maths.lth.se/">Centre for Mathematical 
Sciences</A><BR><A href="http://www.lu.se/">Lund University</A> with <A 
href="http://www.lth.se/">Lund Institute of Technology</A> </SMALL>
<P><SMALL>Comments or corrections to the <A
href="mailto:wafo@maths.lth.se">WAFO group</A>  </P>

<hr><address>Generated on Thu 06-Oct-2005 02:21:16
 for <strong><A href="http://www.maths.lth.se/matstat/wafo/">WAFO</A></strong>
 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>