<html>

<head>

	<link href="stylesheets/style.css" rel="stylesheet" type="text/css">
	<script src="http://www.google.com/jsapi?key=ABQIAAAAJOL4Dbu6i1iFFND9tVK1SxQHoHevx5I6K4zDbyPuyuDTxIU2BBSC_Q4vihWvqWvnnV3Qbrdn-3QeAQ"></Script>
	<script type="text/javascript" src="scripts/js/loadxmldoc.js"></script>
	<script type="text/javascript" src="scripts/js/polydraw.js"></Script>
	<script type="text/javascript" src="scripts/js/soapclient.js"></Script>
	<script type="text/javascript">
		var ge = null;
		var pm = null;
		var kml = null;
		var currentKmlObjects = {'':null};

		google.load("earth", "1", {'other_params': 'sensor=false' });

		// Initialize called on HTML body load
		function init()
		{
			google.earth.createInstance("map3d", initCB, failureCB);
			fillCaseListbox("cases.xml");
		}

		// Initialization for Google Earth
		function initCB(instance)
		{
			ge = instance;
			// Google Earth Plugin Window Properties
			ge.getWindow().setVisibility(true);
			ge.getOptions().setStatusBarVisibility(true);
			// Google Earth Navigation Control Properties
			var navControl = ge.getNavigationControl();
			navControl.setVisibility(ge.VISIBILITY_SHOW);
			// Set starting position : The Netherlands
			var la = ge.createLookAt('');
			la.set(52.05249, 4.58105, 750000, ge.ALTITUDE_RELATIVE_TO_GROUND, 0, 0, 99.99);
			ge.getView().setAbstractView(la);
			// Polygon used for drawing the shape in Google Earth
			pm = new Polygon(0,0,0,0,document.getElementById('polygonselect').value);
			// Load the default case (HK)
			loadCase(0)
		}

		// Initialize KMLs to be shown in Google Earth (needed for export to MathLab)
		function toggleKml(kml_cb)
		{
			file = kml_cb.id;

		    if (currentKmlObjects[file])
		    {
     	      ge.getFeatures().removeChild(currentKmlObjects[file]);
		      currentKmlObject = null;
		    }

			// Load the KML from location if checkbox is checked
			if (kml_cb.value == "on")
			  {
			    loadKml(file)
			  }
		}

		function loadKml(file)
		{
		    // fetch the KML
		    google.earth.fetchKml(ge, file, function(kmlObject)
		       {
			     if (kmlObject)
			     {
			         // show it on Earth
			         currentKmlObjects[file] = kmlObject;
			         ge.getFeatures().appendChild(kmlObject);

			     }
			     else
			     {
			         // bad KML
			         currentKmlObjects[file] = null;

			         // wrap alerts in API callbacks and event handlers in a setTimeout to prevent deadlock in some browsers
			         setTimeout(function()
			         {
			           alert('Bad or null KML.');
			         }, 0);
		         }
		       });
		}


		function loadWMS(wmsLocation)
		{
			var groundOverlay = ge.createGroundOverlay('');
			groundOverlay.setIcon(ge.createIcon(''));
			groundOverlay.getIcon().setHref(wmsLocation);
			groundOverlay.setLatLonBox(ge.createLatLonBox(''));
			var center = ge.getView().copyAsLookAt(ge.ALTITUDE_RELATIVE_TO_GROUND);
			var north = center.getLatitude() + .75;
			var south = center.getLatitude() - .75;
			var east = center.getLongitude() + 1.00;
			var west = center.getLongitude() - 1.00;
			var rotation = 0;
			var latLonBox = groundOverlay.getLatLonBox();
			latLonBox.setBox(north, south, east, west, rotation);
			ge.getFeatures().appendChild(groundOverlay);
		}

		// Call the MatLab SOAP interface, url: SOAP address, method: name
		function CallMatLabSoap(url, method, inputs)
		{

			try
			{
				var pl = new SOAPClientParameters();

				// get inputs
				inputs2 = inputs.split("%");

				// Add variables from document
				pl.add("ncFilePath", inputs2[0]);
				pl.add("ncVariableName", inputs2[1]);
				pl.add("centreLatitude", pm.cent.lat.toDeg());
				pl.add("centreLongitude", pm.cent.lon.toDeg());
				pl.add("vertexLatitude", pm.rad.lat.toDeg());
				pl.add("vertexLongitude", pm.rad.lon.toDeg());
				SOAPClient.invoke(url, method, pl, true, CallMatLabSoapCallBack);
			}
			catch(exception)
			{
				alert(exception);
			}
		}

		// CallBack routine of the SOAP function
		function CallMatLabSoapCallBack(result)
		{
			if(result != null)
			{
			  var balloon = ge.createHtmlStringBalloon('');
			  balloon.setFeature(pm.cent.placemark); // optional
			  balloon.setContentString("<img src='http://dtvirt13/ZMMatLab/output.png'>");

			  ge.setBalloon(balloon);
			}
		}

		// If Google Earth fails to load this function captures the Error Code
		function failureCB(errorCode){}

		// Fill case-selection listbox with available cases
		function fillCaseListbox(xmlFile)
		{
			// first remove all what is in the listbox
			while(caseSelect.options.length!=0)
			caseSelect.options.remove(0);

			caseDoc=loadXMLDoc("xml/" + xmlFile);
			numOfData=caseDoc.getElementsByTagName("title").length;

			for (i=0;i<numOfData;i=i+1)
			{
			var oOption = document.createElement("OPTION");
			oOption.text=caseDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue;
			oOption.value=i;
			oOption.class="vs";
			caseSelect.options.add(oOption)
			}
			return true;
		}

		// Load selected case
		function loadCase(value)
		{
			// fill kmldata listbox
			datafile = caseDoc.getElementsByTagName("datafile")[value].childNodes[0].nodeValue;
			getDataOutOfCase(datafile);

			// zoom to case specific coordinates
			lon_cam = parseFloat(caseDoc.getElementsByTagName("lon")[value].childNodes[0].nodeValue);
			lat_cam = parseFloat(caseDoc.getElementsByTagName("lat")[value].childNodes[0].nodeValue);
			alt_cam = parseFloat(caseDoc.getElementsByTagName("height")[value].childNodes[0].nodeValue);

  			var camera = ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);
  			camera.setLatitude(lat_cam);
  			camera.setLongitude(lon_cam);
  			camera.setAltitude(alt_cam);
  			ge.getView().setAbstractView(camera);
  		}

		// Fill in the listbox with datasources on the basis of the selected case
		function getDataOutOfCase(xmlfile)
		{
			// remove all existing kml objects
			features = ge.getFeatures().getChildNodes()
			for(var i = 0; i < features.getLength(); i++)
			{
			var feat = features.item(i);
			ge.getFeatures().removeChild(feat);
			}

			// empty select lists
			while(kmlForTimeseries.options.length!=0)
			kmlForTimeseries.options.remove(0);

			while(kmlForInterpolation.options.length!=0)
			kmlForInterpolation.options.remove(0);

			// set initial polygon
			pm = new Polygon(0,0,0,0,document.getElementById('polygonselect').value);

			// load case-specific xml file
			xmlDoc=loadXMLDoc("xml/" + xmlfile);
			numOfData=xmlDoc.getElementsByTagName("kml").length;

			// create html-code of checkboxes for each kml found in the case xml and fill up the select lists
			var dataSelectText = [];

			for (i=0;i<numOfData;i=i+1)
			{
				// checkboxes
				dataSelectText = dataSelectText + "<input type='checkbox' class='s' id='" +
									xmlDoc.getElementsByTagName("kml")[i].childNodes[0].nodeValue +
									"' onclick='toggleKml(this)'>" +
									xmlDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue + "<br>"

				file = xmlDoc.getElementsByTagName("kml")[i].childNodes[0].nodeValue;
				currentKmlObjects[file] = null;

				// select lists
				if (xmlDoc.getElementsByTagName("type")[i].childNodes[0].nodeValue == "2dmap") // required for interpolate routine
					{
					var oOption = document.createElement("OPTION");
					oOption.text=xmlDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue;
					oOption.value=xmlDoc.getElementsByTagName("source")[i].childNodes[0].nodeValue + "%" + xmlDoc.getElementsByTagName("varname")[i].childNodes[0].nodeValue;
					oOption.class="vs";
					kmlForInterpolation.options.add(oOption)
					}
				if (xmlDoc.getElementsByTagName("type")[i].childNodes[0].nodeValue == "station") // required for plottimeseries routine
					{
					var oOption = document.createElement("OPTION");
					oOption.text=xmlDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue;
					oOption.value=xmlDoc.getElementsByTagName("source")[i].childNodes[0].nodeValue;
					oOption.class="vs";
					kmlForTimeseries.options.add(oOption)
					}
			}

			document.getElementById("kml_sources").innerHTML =dataSelectText;

			// check if select lists are empty
			if (kmlForInterpolation.options.length==0)
				{
					var oOption = document.createElement("OPTION");
					oOption.text="no suitable data";
					oOption.value=0;
					oOption.class="vs";
					kmlForInterpolation.options.add(oOption)
				}

			if (kmlForTimeseries.options.length==0)
				{
					var oOption = document.createElement("OPTION");
					oOption.text="no suitable data";
					oOption.value=0;
					oOption.class="vs";
					kmlForTimeseries.options.add(oOption)
				}
		}

	</script>
</head>

<body onload='init()' id='body'>
<h1>OpenEarth Data Viewer</h1>
<hr/>
<div style='float:left; width:350px; height:750px; overflow:auto'>
  <table style='font-size:small'>

<!-- CASE SELECTION -->
	<tr>
		<td colspan="2">
		<h3>Select case</h3>
		<p>
		<select name="case" id="caseSelect" onchange="loadCase(this.value)" class="s">
		  <option value="0" class="vs">Select case</option>
		</select>
		<a href="editXml.html"> Add data to case</a>
		</p>
		<hr />
		</td>
	</tr>

<!-- MODE SELECTION (DATA, MODEL or TOOLS) -->
	<tr>
		<td colspan="2">
		<h3>Select mode</h3>
		</td>
	</tr>
	<form id="modeSelect" action='javascript:void(0);'>
		<tr>
			<td colspan="2">
			<input type="radio" name="mode" value="data" />Data
			</td>
		</tr>
		<tr>
			<td colspan="2">
			<input type="radio" name="mode" value="models" />Models
			</td>
		</tr>
		<tr>
			<td colspan="2">
			<input type="radio" name="mode" value="tools" />Tools
			<hr />
			</td>
		</tr>
	</form>
	<hr />

<!-- DATA SELECTION -->
	<tr>
	    <td colspan="2">
	    <h3>Available data</h3>
	    <p>
	    <div id="kml_sources"></div>
	    </p>
	    <hr />
	    </td>
	</tr>

<!-- DRAWING TOOLS -->
	<tr>
		<td colspan="2">
			<h3>Drawing</h3>
		</td>
	</tr>
	<tr>
		<td>
			<form id="polyShape" action='javascript:void(0);'>
			<select name="polygon" id="polygonselect" onchange='pm.numsides = this.value; pm.drawPolygon()' class="s">
				<option value="2" class="vs">Line</option>
				<option value="3" class="vs">Triangle</option>
				<option value="4" class="vs">Square</option>
				<option value="5" class="vs">Pentagon</option>
				<option value="6" class="vs">Hexagon</option>
				<option value="7" class="vs">Heptagon</option>
				<option value="8" class="vs">Octagon</option>
				<option value="9" class="vs">Nonagon</option>
				<option value="10" class="vs">Decagon</option>
				<option value="11" class="vs">Hendecagon</option>
				<option value="12" class="vs">Dodecagon</option>
				<option value="25" class="vs">Circle</option>
			</select>
			</form>
		</td>
		<td>
		Use ctrl + mouse click to draw
		</td>
	</tr>
	<tr><td>Centre: </td	><td><span id='centre'></span></td></tr>
	<tr><td>Vertex: </td><td><span id='outer'></span></td></tr>
	<tr><td>Radius: </td><td><span id='rad'></span></td></tr>
	<tr><td>Bearing: </td><td><span id='bear'></span></td></tr>
	<tr><td>perimeter: </td><td><span id='per'></span></td></tr>
	<tr><td>Area: </td><td><span id='are'></span></td></tr>
	<tr><td colspan="2"><hr /></td></tr>

<!-- ACTION SELECTION -->
	<tr>
	  <td colspan="2">
		<h3>Actions</h3>
	  </td>
	</tr>
    <tr>
      <td>
 		<button style="width:120;height:25" name="Interpoleer" value="Interpoleer" onClick="javascript:CallMatLabSoap('http://dtvirt13/BwnMatLab/BwnFunctions.asmx', 'InterpolateToLine', kmlForInterpolation.value);">Interpolate</button>
 	  </td>
 	  <td>
 	    <select name="kmlForInterpolation" id="kmlForInterpolation" class="s" style="width: 170px">
 	    	<option value="0" class="vs">Select case</option>
		</select>
	  </td>
	</tr>
	<tr>
	  <td>
     	<button style="width:120;height:25" name="Plot timeseries" value="Plot timeseries" onClick="javascript:CallMatLabSoap('http://dtvirt13/BwnMatLab/BwnFunctions.asmx', 'PlotTimeSeries', kmlForTimeseries.value);">Plot timeseries</button>
      </td>
      <td>
 	    <select name="kmlForTimeseries" id="kmlForTimeseries" class="s" style="width: 170px">
 	    	<option value="0" class="vs">Select case</option>
		</select>
 	  </td>
	</tr>
</table>
</div>
<div id='map3d_container' style='border: 1px solid silver; height: 750px; margin-left:350px;'>
	<div id='map3d' style='height: 100%;'></div>
</div>
<hr/>
    This tool is provided by: <br />
    <a href="http://openearth.eu" target="_blank"><img src="https://public.deltares.nl/download/attachments/16876019/OET?version=1" align="left" width="100"/></a>
</body>

</html>
