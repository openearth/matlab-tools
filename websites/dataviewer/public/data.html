<html>

<head>

	<link href="stylesheets/style.css" rel="stylesheet" type="text/css">
	<script src="http://www.google.com/jsapi?key=ABQIAAAAJOL4Dbu6i1iFFND9tVK1SxQHoHevx5I6K4zDbyPuyuDTxIU2BBSC_Q4vihWvqWvnnV3Qbrdn-3QeAQ"></Script>
	<script type="text/javascript" src="scripts/js/loadxmldoc.js"></script>
	<script type="text/javascript" src="scripts/js/polydraw.js"></Script>
	<script type="text/javascript" src="scripts/js/soapclient.js"></Script>
	<script type="text/javascript" src="scripts/js/matlabsoap.js"></Script>
	<script type="text/javascript" src="scripts/js/getQueryString.js"></Script>
	<script type="text/javascript">
		var ge = null;
		var pm = null;
		var kml = null;
		var currentKmlObjects = {'':null};

		google.load("earth", "1", {'other_params': 'sensor=false' });

		// Initialize called on HTML body load
		function init()
		{
			google.earth.createInstance("map3d", initCB, failureCB);
		}

		// Initialization for Google Earth
		function initCB(instance)
		{
			ge = instance;
			// Google Earth Plugin Window Properties
			ge.getWindow().setVisibility(true);
			ge.getOptions().setStatusBarVisibility(true);
			// Google Earth Navigation Control Properties
			var navControl = ge.getNavigationControl();
			navControl.setVisibility(ge.VISIBILITY_SHOW);
			// Set starting position : The Netherlands
			var la = ge.createLookAt('');
			la.set(52.05249, 4.58105, 750000, ge.ALTITUDE_RELATIVE_TO_GROUND, 0, 0, 99.99);
			ge.getView().setAbstractView(la);
			// Polygon used for drawing the shape in Google Earth
			pm = new Polygon(0,0,0,0,document.getElementById('polygonselect').value);

			// Load requested case
			loadCase(getQuerystring('case'));

		}

		// Initialize KMLs to be shown in Google Earth (needed for export to MathLab)
		function toggleKml(kml_cb)
		{
			file = kml_cb.id;

		    if (currentKmlObjects[file])
		    {
     	      ge.getFeatures().removeChild(currentKmlObjects[file]);
		      currentKmlObject = null;
		    }

			// Load the KML from location if checkbox is checked
			if (kml_cb.value == "on")
			  {
			    loadKml(file)
			   // setTimeSlider(); doen we nog maar ff niet, werkt nog niet lekker....

			  }

		}

		function setTimeSlider()
		{
			// set timeslider to last time step
			var extents = ge.getTime().getControl().getExtents();
			var gts = ge.createTimeStamp('');
			gts.getWhen().set(extents.getEnd().get());
			ge.getTime().setTimePrimitive(gts);
		}


		function loadKml(file)
		{
		    // fetch the KML
		    google.earth.fetchKml(ge, file, function(kmlObject)
		       {
			     if (kmlObject)
			     {
			         // show it on Earth
			         currentKmlObjects[file] = kmlObject;
			         ge.getFeatures().appendChild(kmlObject);

			     }
			     else
			     {
			         // bad KML
			         currentKmlObjects[file] = null;

			         // wrap alerts in API callbacks and event handlers in a setTimeout to prevent deadlock in some browsers
			         setTimeout(function()
			         {
			           alert('Bad or null KML.');
			         }, 0);
		         }
		       });
		}


		function loadWMS(wmsLocation)
		{
			var groundOverlay = ge.createGroundOverlay('');
			groundOverlay.setIcon(ge.createIcon(''));
			groundOverlay.getIcon().setHref(wmsLocation);
			groundOverlay.setLatLonBox(ge.createLatLonBox(''));
			var center = ge.getView().copyAsLookAt(ge.ALTITUDE_RELATIVE_TO_GROUND);
			var north = center.getLatitude() + .75;
			var south = center.getLatitude() - .75;
			var east = center.getLongitude() + 1.00;
			var west = center.getLongitude() - 1.00;
			var rotation = 0;
			var latLonBox = groundOverlay.getLatLonBox();
			latLonBox.setBox(north, south, east, west, rotation);
			ge.getFeatures().appendChild(groundOverlay);
		}

	// If Google Earth fails to load this function captures the Error Code
		function failureCB(errorCode){}

		// Load selected case
		function loadCase(value)
		{
			// fill kmldata listbox
			var caseDoc = loadXMLDoc("xml/cases.xml");
			document.getElementById("case_title").innerHTML = "<h3>" + caseDoc.getElementsByTagName("title")[value].childNodes[0].nodeValue + " Data</h3>";
			datafile = caseDoc.getElementsByTagName("datafile")[value].childNodes[0].nodeValue;
			getDataOutOfCase(datafile,"data");

			// zoom to case specific coordinates
			lon_cam = parseFloat(caseDoc.getElementsByTagName("lon")[value].childNodes[0].nodeValue);
			lat_cam = parseFloat(caseDoc.getElementsByTagName("lat")[value].childNodes[0].nodeValue);
			alt_cam = parseFloat(caseDoc.getElementsByTagName("height")[value].childNodes[0].nodeValue);

  			var camera = ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);
  			camera.setLatitude(lat_cam);
  			camera.setLongitude(lon_cam);
  			camera.setAltitude(alt_cam);
  			ge.getView().setAbstractView(camera);
  		}

		// Fill up the data source area with datasources on the basis of the selected case
		function getDataOutOfCase(xmlfile,mode)
		{
			// remove all existing kml objects
			features = ge.getFeatures().getChildNodes()
			for(var i = 0; i < features.getLength(); i++)
			{
			var feat = features.item(i);
			ge.getFeatures().removeChild(feat);
			}

			// empty select lists
			while(kmlForInterpolation.options.length!=0)
			kmlForInterpolation.options.remove(0);

			// set initial polygon
			pm = new Polygon(0,0,0,0,document.getElementById('polygonselect').value);

			// load case-specific xml file
			xmlDoc=loadXMLDoc("xml/" + xmlfile);
			numOfData=xmlDoc.getElementsByTagName(mode).length;

			// create html-code of checkboxes for each kml found in the case xml and fill up the select lists
			var dataSelectText = [];

			for (i=0;i<numOfData;i=i+1)
			{
				// checkboxes
				dataSelectText = dataSelectText + "<input type='checkbox' class='s' id='" +
									xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("kml")[0].textContent +
									"' onclick='toggleKml(this)'>" +
									xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("title")[0].textContent + "<br>"

				file = xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("kml")[0].textContent;
				currentKmlObjects[file] = null;

				// select lists for interpolatetoline function
				if (xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("interpolatetoline").length == 1)
					{
					var oOption = document.createElement("OPTION");
					oOption.text  = xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("title")[0].textContent;
					oOption.value = xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("interpolatetoline")[0].getElementsByTagName("source")[0].textContent + "&" +
								    xmlDoc.getElementsByTagName(mode)[i].getElementsByTagName("interpolatetoline")[0].getElementsByTagName("varname")[0].textContent;
					oOption.class = "vs";
					kmlForInterpolation.options.add(oOption)
					}
			}

			document.getElementById("kml_sources").innerHTML =dataSelectText;

			// check if select lists are empty
			if (kmlForInterpolation.options.length==0)
				{
					var oOption = document.createElement("OPTION");
					oOption.text="no suitable data";
					oOption.value=0;
					oOption.class="vs";
					kmlForInterpolation.options.add(oOption)
				}
		}

	</script>
</head>

<body onload='init()' id='body'>
<h1>OpenEarth Data Viewer</h1>
<table width="350" class="links">
	<tr>
		<td>Data</td>
		<td>
		<script type="text/javascript">
		document.write("<a href=models.html?case=" + getQuerystring('datacase') + ">Models</a>");
		</script>
		</td>
		<td>
		<script type="text/javascript">
		document.write("<a href=tool.html?case=" + getQuerystring('datacase') + ">Tools</a>");
		</script>
		</td>
	</tr>
</table>

<hr/>
<div style='float:left; width:350px; height:750px; overflow:auto'>
  <table style='font-size:small'>

<!-- DATA SELECTION -->
	<tr>
	    <td colspan="2">
	    <div id="case_title"></div>
	    <p>
	    <div id="kml_sources"></div>
	    </p>
	    <hr />
	    </td>
	</tr>

<!-- DRAWING TOOLS -->
	<tr>
		<td colspan="2">
			<h3>Drawing</h3>
		</td>
	</tr>
	<tr>
		<td>
			<form id="polyShape" action='javascript:void(0);'>
			<select name="polygon" id="polygonselect" onchange='pm.numsides = this.value; pm.drawPolygon()' class="s">
				<option value="2" class="vs">Line</option>
				<option value="3" class="vs">Triangle</option>
				<option value="4" class="vs">Square</option>
				<option value="5" class="vs">Pentagon</option>
				<option value="6" class="vs">Hexagon</option>
				<option value="7" class="vs">Heptagon</option>
				<option value="8" class="vs">Octagon</option>
				<option value="9" class="vs">Nonagon</option>
				<option value="10" class="vs">Decagon</option>
				<option value="11" class="vs">Hendecagon</option>
				<option value="12" class="vs">Dodecagon</option>
				<option value="25" class="vs">Circle</option>
			</select>
			</form>
		</td>
		<td>
		Use ctrl + mouse click to draw
		</td>
	</tr>
	<tr><td colspan="2"><hr /></td></tr>

<!-- ACTION SELECTION -->
	<tr>
	  <td colspan="2">
		<h3>Actions</h3>
	  </td>
	</tr>
    <tr>
      <td>
 		<button style="width:120;height:25" name="Interpoleer" value="Interpoleer" onClick="javascript:CallMatLabSoap('http://dtvirt13/BwnMatLab/BwnFunctions.asmx', 'InterpolateToLine', kmlForInterpolation.value);">Interpolate</button>
 	  </td>
 	  <td>
 	    <select name="kmlForInterpolation" id="kmlForInterpolation" class="s" style="width: 170px">
 	    	<option value="0" class="vs">Select case</option>
		</select>
	  </td>
	</tr>

</table>
</div>
<div id='map3d_container' style='border: 1px solid silver; height: 750px; margin-left:350px;'>
	<div id='map3d' style='height: 100%;'></div>
</div>
<hr/>
    This tool is provided by: <br />
    <a href="http://openearth.eu" target="_blank"><img src="https://public.deltares.nl/download/attachments/16876019/OET?version=1" align="left" width="100"/></a>
</body>

</html>
