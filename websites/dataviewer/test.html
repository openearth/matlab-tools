<html>

<head>

	<script src="http://www.google.com/jsapi?key=ABQIAAAAJOL4Dbu6i1iFFND9tVK1SxSAhoPlMsemz_zPU0HAErPwAMQQehTyXZ5JZhQJusZ8p76o368XUHo9LQ"></Script>
	<script type="text/javascript" src="loadxmldoc.js"></script>
	<script type="text/javascript" src="polydraw.js"></Script>
	<script type="text/javascript" src="soapclient.js"></Script>
	<script type="text/javascript">
		var ge = null;
		var pm = null;
		var kml = null;

		google.load("earth", "1", {'other_params': 'sensor=false' });

		// Initialize called on HTML body load
		function init()
		{
			google.earth.createInstance("map3d", initCB, failureCB);
			fillCaseListbox("cases.xml");
		}

		// Fill case-selection listbox with available cases
		function fillCaseListbox(xmlFile)
		{
			// first remove all what is in the listbox
			while(case_listbox.options.length!=0)
			case_listbox.options.remove(0);

			caseDoc=loadXMLDoc(xmlFile);
			numOfData=caseDoc.getElementsByTagName("title").length;

			for (i=0;i<numOfData;i=i+1)
			{
			var oOption = document.createElement("OPTION");
			oOption.text=caseDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue;
			oOption.value=i;
			oOption.class="vs";
			case_listbox.options.add(oOption)
			}
			return true;
		}


		// Initialization for Google Earth
		function initCB(instance)
		{
			ge = instance;
			// Google Earth Plugin Window Properties
			ge.getWindow().setVisibility(true);
			ge.getOptions().setStatusBarVisibility(true);
			// Google Earth Navigation Control Properties
			var navControl = ge.getNavigationControl();
			navControl.setVisibility(ge.VISIBILITY_SHOW);
			// Set starting position : The Netherlands
			var la = ge.createLookAt('');
			la.set(52.05249, 4.58105, 750000, ge.ALTITUDE_RELATIVE_TO_GROUND, 0, 0, 99.99);
			ge.getView().setAbstractView(la);
			// Polygon used for drawing the shape in Google Earth
			pm = new Polygon(0,0,0,0,document.getElementById('polygonselect').value);
			// Load the desired KML on start
			loadKML('http://dtvirt13/test/ahn100.kmz');
		}

		// Initialize KMLs to be shown in Google Earth (needed for export to MathLab)
		function loadKML(kmlLocation)
		{
			// If a previous KML has been loaded, unload it.
			if (kml != null)
			{
				ge.getFeatures().removeChild(kml);
			}
			// Load the KML from location
			google.earth.fetchKml(ge, kmlLocation,  function(kmlObject)
													{
														if (kmlObject)
														{
															kml = kmlObject;
															ge.getFeatures().appendChild(kmlObject);
														}
													}
			);
		}

		function loadWMS(wmsLocation)
		{
			var groundOverlay = ge.createGroundOverlay('');
			groundOverlay.setIcon(ge.createIcon(''));
			groundOverlay.getIcon().setHref(wmsLocation);
			groundOverlay.setLatLonBox(ge.createLatLonBox(''));
			var center = ge.getView().copyAsLookAt(ge.ALTITUDE_RELATIVE_TO_GROUND);
			var north = center.getLatitude() + .75;
			var south = center.getLatitude() - .75;
			var east = center.getLongitude() + 1.00;
			var west = center.getLongitude() - 1.00;
			var rotation = 0;
			var latLonBox = groundOverlay.getLatLonBox();
			latLonBox.setBox(north, south, east, west, rotation);
			ge.getFeatures().appendChild(groundOverlay);
		}

		// Call the MatLab SOAP interface, url: SOAP address, method: name
		function CallMatLabSoap(url, method)
		{
			document.getElementById("inter_image").src = "no_image.gif";
			try
			{
				var pl = new SOAPClientParameters();
				// Add variables from document
				pl.add("kmlFile", kml);
				pl.add("centreLatitude", pm.cent.lat.toDeg());
				pl.add("centreLongitude", pm.cent.lon.toDeg());
				pl.add("vertexLatitude", pm.rad.lat.toDeg());
				pl.add("vertexLongitude", pm.rad.lon.toDeg());
				SOAPClient.invoke(url, method, pl, true, CallMatLabSoapCallBack);
			}
			catch(exception)
			{
				alert(exception);
			}
		}

		// CallBack routine of the SOAP function
		function CallMatLabSoapCallBack(result)
		{
			if(result != null)
			{
				document.getElementById("inter_image").src = "http://dtvirt13/ZMMatLab/output.png";
			}
		}

		// If Google Earth fails to load this function captures the Error Code
		function failureCB(errorCode){}

		// Load selected case
		function loadCase(value)
		{
			// fill kmldata listbox
			datafile = caseDoc.getElementsByTagName("datafile")[value].childNodes[0].nodeValue;
			getDataOutOfCase(datafile);

			// zoom to case specific coordinates
			lon = parseFloat(caseDoc.getElementsByTagName("lon")[value].childNodes[0].nodeValue);
			lat = parseFloat(caseDoc.getElementsByTagName("lat")[value].childNodes[0].nodeValue);
			alt = parseFloat(caseDoc.getElementsByTagName("height")[value].childNodes[0].nodeValue);

  			var camera = ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);
  			camera.setLatitude(lat);
  			camera.setLongitude(lon);
  			camera.setAltitude(alt);
  			ge.getView().setAbstractView(camera);
  		}

		// Fill in the listbox with datasources on the basis of the selected case
		function getDataOutOfCase(xmlfile)
		{

			// first remove all what is in the listbox
			while(kml_listbox.options.length!=0)
			  kml_listbox.options.remove(0);

			// now load the requested xml-file
			xmlDoc=loadXMLDoc(xmlfile);
			numOfData=xmlDoc.getElementsByTagName("kml").length;

			for (i=0;i<numOfData;i=i+1)
			{
			var oOption = document.createElement("OPTION");
			oOption.text=xmlDoc.getElementsByTagName("title")[i].childNodes[0].nodeValue;
			oOption.value=xmlDoc.getElementsByTagName("kml")[i].childNodes[0].nodeValue;
			oOption.class="vs";
			kml_listbox.options.add(oOption)
			}
			return true;
		}
	</script>

	<style type="text/css">
		select.s {font-size: 10px;}
		input.vs {font-size: 8px;}
		input.s {font-size: 9px;}
	</style>

</head>

<body onload='init()' id='body'>

<div style='float:left; width:250px; height:550px; overflow:auto'>
  <table style='font-size:small'>
	<tr>
		<td>
		<form name="caseSelect" action='javascript:void(0);'>
		<p>
		<h3>Select case</h3>
		<select name="case" id="caseSelect" onchange="loadCase(this.value)" class="s">
		  <option value="0" class="vs">Select case</option>
		<script type="text/javascript">case_listbox=document.caseSelect.caseSelect</script>
		</select>
		</p>
		</form>
		</td>
	</tr>

	<tr>
		<td>
        <form name="kmlSelect" action='javascript:void(0);'>
		<p>
		<h3>Select data</h3>
		<select name="kmlSelect" onchange='loadKML(this.value)' class="s">
		  <option value="" class="vs">Select case first</option>
		<script type="text/javascript">kml_listbox=document.kmlSelect.kmlSelect</script>
		</select>
		</p>
		</form>
		</td>
	</tr>

    <tr>
		<td>
		<form id="polyShape" action='javascript:void(0);'>
		<p>
		<h3>Actions</h3>
		<select name="polygon" id="polygonselect" onchange='pm.numsides = this.value; pm.drawPolygon()' class="s">
			<option value="2" class="vs">Line</option>
			<option value="3" class="vs">Triangle</option>
			<option value="4" class="vs">Square</option>
			<option value="5" class="vs">Pentagon</option>
			<option value="6" class="vs">Hexagon</option>
			<option value="7" class="vs">Heptagon</option>
			<option value="8" class="vs">Octagon</option>
			<option value="9" class="vs">Nonagon</option>
			<option value="10" class="vs">Decagon</option>
			<option value="11" class="vs">Hendecagon</option>
			<option value="12" class="vs">Dodecagon</option>
			<option value="25" class="vs">Circle</option>
		</select></p>
		</form>
		</td>
	</tr>

	<tr><td>Centre: </td><td><span id='centre'></span></td></tr>
	<tr><td>Vertex: </td><td><span id='outer'></span></td></tr>
	<tr><td>Radius: </td><td><span id='rad'></span></td></tr>
	<tr><td>Bearing: </td><td><span id='bear'></span></td></tr>
	<tr><td>perimeter: </td><td><span id='per'></span></td></tr>
	<tr><td>Area: </td><td><span id='are'></span></td></tr>

	<tr>
		<td>
			<form id="interpoleButton" action='javascript:void(0);'>
				<input type="submit" name="Interpoleer" value="Interpoleer" onClick="javascript:CallMatLabSoap('http://dtvirt13/ZMMatLab/Interpolate.asmx', 'InterpolateToLine');">
			</form>
		</td>
	</tr>
</table>
<hr/>
  Drag pushpins to size, locate and rotate,<br><br>
  Crtl + mouse, moves the polygon to a new location.
</div>

<div id='map3d_container' style='border: 1px solid silver; height: 550px; margin-left:250px;'>
	<div id='map3d' style='height: 100%;'></div>
</div>

<div id='interpolate_container' style='border: 1px solid silver; height: 350px; margin-left:250px;'>
	<div id='interpolate' style='height: 100%;'>
		<center><img id="inter_image" src="no_image.gif"></center>
	</div>
</div>

</body>

</html>
