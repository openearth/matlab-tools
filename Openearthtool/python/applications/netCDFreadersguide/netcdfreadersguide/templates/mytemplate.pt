<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="pyramid web application">
    <meta name="author" content="Kees den Heijer">
    <link rel="shortcut icon" href="${request.static_url('netcdfreadersguide:static/pyramid-16x16.png')}">

    <title>netCDF readers guide</title>

    <!-- Bootstrap core CSS -->
    <link href="//oss.maxcdn.com/libs/twitter-bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this scaffold -->
    <link href="${request.static_url('netcdfreadersguide:static/theme.css')}" rel="stylesheet">
    <link href="${request.static_url('netcdfreadersguide:static/style.css')}" rel="stylesheet">
    <link href="${request.static_url('netcdfreadersguide:static/spinner.css')}" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <!--?<link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.css" rel="stylesheet">-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/5.2.3/css/bootstrap-slider.min.css" rel="stylesheet">
    <script src="//oss.maxcdn.com/libs/jquery/1.10.2/jquery.min.js"></script>
    <!--?<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/5.2.3/bootstrap-slider.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#button-upload').click(function() {
                $('#spinner').show();
//            $("#ex2").slider({});
            });


            window.jsonroot = window.location.href + 'json/';
//            getlanguages();
            $('#submit_button').click( function() {
                var lang = $('.btn.btn-default.active input').val(),
                        langtext = $('.btn.btn-default.active input').parent().text(),
                        url = '?url=' + $("#data_url").val(),
                        sliders = $("input[id^='dim_slider_']"),
                        download = '&download=' + $('#chk_download').is(":checked"),
                        dims = '',
                        variables = '&variables=' + $('#var:checked').map(function() {return this.value;}).get().join(',');
                $.each(sliders, function () {
                    var amin = $(this).slider("getValue")[0] != $(this).data('slider-min'),
                            amax = $(this).slider("getValue")[1] != $(this).data('slider-max');
                    console.log($(this).attr('id').replace('dim_slider_', ''))
                    console.log($(this).slider("getValue")[0], $(this).data('slider-min'))
                    console.log($(this).slider("getValue")[1], $(this).data('slider-max'))
                    if (amin || amax) {
                        var dim_name = $(this).attr('id').replace('dim_slider_', '');
                        dims = dims + '&dim_' + dim_name + '=' + $(this).slider("getValue")[0] + ':1:' + ($(this).slider("getValue")[1])
                    }
                });
                $('.output-title').text(langtext + " netCDF readers guide output");
                output_url = window.location.href + 'script/' + lang + url + download + dims + variables;
                if ($('#chk_download').is(":checked")) {
                    $('form').attr('action', output_url)
                }
                else {
                    $('#script pre').text("");
//                    $('#spinner').show();
                    $.get(output_url, function (data){
                        $('#script pre').text(data.replace('guide', 'guide ' + window.location.href));
                    });
//                    $('#spinner').hide();
                    $('#formModal').attr('action', output_url)
                }
                });
            $("#data_url")
                    .change(
                    function () {
                        $('ul#variables').empty();
                        $('ul#dimensions').empty();
                        if ($(this).val() == "") {
                            $(".input-group-addon").removeClass("alert-danger").removeClass("alert-success")
                        }
                        else {
                            checknc($(this).val());
                        }
                    });
//            $('#dimensions').bind('valid_url', null, function(){
//                console.log($("#data_url").val())
//            });
            $('#chk_download').click(function() {
                // toggle download file
                var download = $(this);
                if (download.is(":checked")) {
                    $('#submit_button')
                            .removeAttr('data-target')
                            .removeAttr('data-toggle');
                }
                else {
                    $('#submit_button')
                            .attr('data-target', "#outputModal")
                            .attr('data-toggle', "modal")
                }
            });
        });
        function checknc(url) {
            // check whether provided url is valid
            $.getJSON(jsonroot + 'checknc?url=' + url, function(data) {
                $('div#dimensions').empty();
                $('div#variables').empty();
                if (data == 'true') {
                    $(".input-group-addon").removeClass("alert-danger").addClass("alert-success");
                    getdimensions(url);
                    getvariables(url);
                    $('#submit_button').prop('disabled', false);
                }
                else {
                    $(".input-group-addon").removeClass("alert-success").addClass("alert-danger");
                    $('#submit_button').prop('disabled', true);
                }
            });
        }
        function getdimensions(url) {
            // get dimensions of netcdf
            $.getJSON( jsonroot+'dimensions?url=' + url , function(data) {
                $.each(data, function (i, value) {
                    var div = $("<div>").attr('style', 'height: 25px;'),
                            k = value.name,
                            v = value.length-1,
                            label = $('<label>').attr('for', 'dim_slider_'+ k).text(k),
//                            inp = $('<input readonly>').attr('type', 'text').attr('id', 'dim_'+ k).attr('style', 'border:10;'),
                            slid = $("<input>")
                                    .attr('type', 'text')
                                    .addClass('span2')
                                    .attr('id', 'dim_slider_'+k)
                                    .attr('value', '')
                                    .attr('data-slider-value', "[0,"+v+"]")
                                    .attr('data-slider-min', 0)
                                    .attr('data-slider-id', 'ex1Slider')
                                    .attr('data-slider-max', v)
                                    .attr('style', 'width: 100%;');
//                    {
//                                min: 0,
//                                max: v,
//                                range: true,
//                                values: [0, v],
//                                slide: function( event, ui ) {
//                                        $(ui.handle).text(ui.value);
//                                        $( "#dim_"+ k ).val( ui.values[ 0 ] + " : 1 : " + ui.values[ 1 ] );
//                                        }});
                   $('div#dimensions').append(div, label, slid);
                    slid.slider({
                        tooltip: 'always',
                        formatter: function(value) {
                            return k + ' [' + value[0] + ' : 1 : ' + (value[1]) + ']';
                        }
                    }).on('slide', function () {
                        $( "#dim_"+ k ).val( slid.slider('getValue')[ 0 ] + " : 1 : " + slid.slider('getValue')[ 1 ] );
                    });
                    $( "#dim_"+ k ).val( slid.slider('getValue')[ 0 ] + " : 1 : " + slid.slider('getValue')[ 1 ] );
                });
            })
        }
        function getvariables(url) {
            // get variables of netcdf
            $.getJSON( jsonroot+'variables?url=' + url , function(data) {
                $.each(data, function (i, value) {
                    var txt = value.name;
                    if (value.dimensions.length > 0) {
                        txt = txt + ' (' + value.dimensions + ')'
                    }
                      $('div#variables')
                              .append($("<div>").addClass("checkbox")
                                      .append($('<label>')
                                              .text(txt)
                                              .append($('<input>')
                                                      .attr('type', 'checkbox')
                                                      .attr('value', value.name)
                                                      .attr('id', 'var')
                                                      )));
                });
                $('#spinner').hide()
            })
        }
//        function getlanguages() {
//            $.getJSON( jsonroot+'languages' , function(data) {
//                $.each(data, function (i, value) {
//                    var btn = $('<label class="btn btn-default">').text(value['name']).append('<input type="radio" value="python" autocomplete="off" checked>')
//                    $('#languages').append(btn)
//                });
//            });
//        }
    </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="//oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="starter-template">
      <div class="container">
          <form method="post" action="" target="output">

          <!-- Data url -->
          <div class="panel panel-primary">
            <div class="panel-heading">Data url</div>
            <div class="panel-body">
              <div class="input-group" title="provide here the url of your data source">
                <span class="input-group-addon" id="basic-addon1"> .nc</span>
                <input type="text" id="data_url" class="form-control" placeholder="data url" aria-describedby="basic-addon1">
              </div>
            </div>
          </div>

          <div class="row">
              <!-- Dimensions -->
              <div class="col-sm-5">
                  <div class="panel panel-primary">
                      <div class="panel-heading">Dimensions</div>
                      <div class="panel-body" id="dimensions_bod">
                          <div class="col-sm-1"></div>
                          <div class="col-sm-10" id="dimensions"></div>
                          <div class="col-sm-1"></div>
                      </div>
                  </div>
              </div>

              <!-- Variables -->
              <div class="col-sm-4">
                  <div class="panel panel-primary">
                    <div class="panel-heading">Variables</div>
                    <div class="panel-body" id="variables">
                    </div>
                  </div>
              </div>

              <!-- Output -->
              <div class="col-sm-3">
                  <div class="panel panel-primary">
                    <div class="panel-heading">Output</div>
                    <div class="panel-body" id="output">
                        <div class="btn-group-vertical btn-block"  data-toggle="buttons" role="group" id="language">
                            <label class="btn btn-default active">
                                <input type="radio" value="python" autocomplete="off" checked>Python
                            </label>
                            <!--?<label class="btn btn-default">-->
                                <!--?<input type="radio" value="matlab_oet" autocomplete="off">Matlab (OET)-->
                            <!--?</label>-->
                            <label class="btn btn-default">
                                <input type="radio" value="matlab" autocomplete="off">Matlab
                            </label>
                        </div>
                        <div class="checkbox">
                            <label>download as file
                            <input type="checkbox" value="" id="chk_download">
                            </label>
                        </div>
                        <div class="btn-group-vertical btn-block" role="group" aria-label="...">
                            <button type="submit" id="submit_button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#outputModal" disabled>Go!</button>
                        </div>
                        <div class="btn-group-vertical btn-block" role="group" aria-label="...">
                            <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#aboutModal">About</button>
                        </div>

                        <div id="spinner" class="spinner" style="display:none;">
                            <i class="fa fa-circle-o-notch fa-spin fa-pulse fa-5x"></i>
                        </div>

                    </div>
                  </div>
              </div>

          </div>
          </form>

          <!-- Modal output -->
          <div class="modal fade large" id="outputModal" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title output-title">netCDF readers guide output</h4>
                </div>
                <div class="modal-body" id="script">
                    <pre style="word-wrap: break-word; white-space: pre-wrap;">
                    </pre>
                </div>
                <div class="modal-footer">
                    <form action="" method="post" target="output" id="formModal">
                        <button type="submit" class="btn btn-primary">Download as file</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </form>
                </div>
              </div>

            </div>
          </div>

            <!-- Modal about -->
          <div class="modal fade" id="aboutModal" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">About netCDF readers guide</h4>
                </div>
                <div class="modal-body">
                    <p>The netCDF readers guide is meant to facilitate you in reading data from netCDF files.</p>
                    <p>It allows you to confine the selection in the dimensions and choose particular variables.</p>
                    <p>This tool provides you with a script, in the programming language of your preference, to read the data of your selection.</p>
                    <a href="http://www.openearth.nl/"><img height=20px src="${request.static_url('netcdfreadersguide:static/OE_logo.svg')}"></a>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
              </div>

            </div>
          </div>

        <div class="footer text-right">
            Copyright <i class="fa fa-copyright"></i> 2015-${year} Kees den Heijer <a href="http://www.openearth.nl/"><img height=20px src="${request.static_url('netcdfreadersguide:static/OE_logo.svg')}"></a>
        </div>

        </div>

    </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//oss.maxcdn.com/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
  </body>
</html>
